#!/usr/bin/env bash

set -x

ipc_server_folder="/var/tmp/9572cf67-b586-4c68-a7da-7cb904b396b3"
words=~/.local/share/dict/words

[[ -d "${ipc_server_folder}" ]] || mkdir "${ipc_server_folder}"

next_available_name(){
  lc=$(wc -l < "${words}")
  for (( i = 1; i <= ${lc}; i++ )); do
    w=$(head -n ${i} "${words}")
    s="${ipc_server_folder}/${w}"
    if [[ ! -e "${s}"  ]]; then
      echo "${w}"
      return
    fi
  done
}

name=""
socket=()

if [[ -f "${words}" ]]; then
  name=$(next_available_name)

  if [[ -n ${name} ]]; then
    socket=(--input-ipc-server="${ipc_server_folder}/${name}")
  fi
fi

mpv=(mpv --title="[${name}] \${filename}" "${socket[@]}" --msg-level=all=no --terminal=no --playlist-start=0)

if [[ ${#} -eq 0  ]]; then
  <&0 xargs -d'\n' setsid -f "${mpv[@]}"
  exit
fi

if [[ "${!#}" == "-" ]]; then
  <&0 xargs -d'\n' setsid -f "${mpv[@]}" "${@:1:$#-1}" # drop the last parameter
  exit
fi

setsid -f "${mpv[@]}" "${@}"
